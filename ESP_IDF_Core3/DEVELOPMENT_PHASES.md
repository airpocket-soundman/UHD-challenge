# 開発フェーズ計画

## 現在のステータス
- ✅ Phase 0: プロジェクトセットアップ完了
- ✅ Phase 1: ディスプレイ表示テスト完了 (2025/12/09)

---

## Phase 1: ディスプレイ表示テスト ✅
**目的**: LVGLを使用してM5Stack CoreS3のディスプレイに"Hello World"を表示

**完了内容**:
- BSPライブラリを使用したディスプレイ初期化
- LVGLによるUI要素の作成
- フォント設定と中央配置
- 安定動作確認 (Free heap: 8.5MB)

**成果物**: 
- `main/main.cpp` - ディスプレイテストコード

---

## Phase 2: microSDファイル読み込みテスト
**目的**: microSDカードをマウントし、ファイルシステムへのアクセスを確認

**タスク**:
1. SDカードのマウント処理を実装
2. ファイル一覧の取得
3. テキストファイルの読み書きテスト
4. エラーハンドリングの実装

**検証項目**:
- SDカードの自動検出
- FATファイルシステムのマウント成功
- ファイル操作（open/read/write/close）
- ディレクトリ操作

**想定ファイル**:
- `main/sd_card.cpp` - SDカード操作ユーティリティ
- `main/sd_card.h` - ヘッダーファイル

---

## Phase 3: microSDからJPG読み取って画面に表示するテスト
**目的**: SDカードからJPEG画像を読み込み、ディスプレイに表示

**タスク**:
1. JPEG画像のSDカードからの読み込み
2. JPEGデコード処理の実装（esp_jpegライブラリ使用）
3. デコードした画像データをLVGLで表示
4. 画像の拡大縮小/配置調整

**検証項目**:
- 様々なサイズのJPEG画像の読み込み
- メモリ効率の確認（PSRAM使用）
- デコード速度の測定
- ディスプレイへの正常な描画

**想定ファイル**:
- `main/image_loader.cpp` - 画像読み込み・デコード処理
- `main/image_loader.h`
- テスト用JPEG画像をSDカードに配置

---

## Phase 4: 読み取ったJPGにBB（バウンディングボックス）をダミーで書き込むテスト
**目的**: 画像上にバウンディングボックスとラベルを描画する機能の実装

**タスク**:
1. ダミーのBB座標データを定義（例: 人物検出を想定）
2. LVGL描画APIを使用してBBを矩形描画
3. クラスラベル（例: "person", "car"）とスコアの表示
4. 複数のBBを同時描画

**検証項目**:
- BBの色分け（クラス別）
- ラベルの可読性
- 描画パフォーマンス
- 座標変換の正確性

**想定ファイル**:
- `main/bbox_drawer.cpp` - BB描画ユーティリティ
- `main/bbox_drawer.h`

**ダミーデータ例**:
```cpp
struct BBox {
    float x1, y1, x2, y2;  // 正規化座標 (0.0-1.0)
    int class_id;
    float confidence;
    const char* label;
};
```

---

## Phase 5: ESP-DLでモデルをSDから読み込むテスト
**目的**: SDカードに保存されたESP-DLモデルファイルを読み込み、推論準備

**タスク**:
1. ESPDLモデルファイル（.espdl）をSDに配置
2. ESP-DLライブラリを使用したモデルロード
3. モデル情報の取得（入力サイズ、出力サイズ、クラス数）
4. メモリ割り当ての確認

**検証項目**:
- モデルファイルの正常読み込み
- メモリフットプリントの測定
- モデルメタデータの確認
- エラーハンドリング（ファイル不正など）

**想定ファイル**:
- `main/model_loader.cpp` - モデルロード処理
- `main/model_loader.h`
- `sdcard/models/uhd_model.espdl` - ESP-DLモデルファイル

**使用モデル**: UHD-Net (Ultra-Handheld Detection)
- 入力: 64x64 RGB
- 出力: バウンディングボックス + クラス確率

---

## Phase 6: 推論してBB書いてディスプレイに表示するテスト（統合テスト）
**目的**: 全機能を統合し、エンドツーエンドの物体検出システムを構築

**タスク**:
1. SDからJPEG画像を読み込み
2. 画像を64x64にリサイズ・前処理
3. ESP-DLモデルで推論実行
4. 推論結果（BB座標、クラス、スコア）を取得
5. 元画像上にBBを描画
6. ディスプレイに表示

**検証項目**:
- エンドツーエンドの処理時間測定
- 推論精度の確認
- メモリ使用量の監視
- UIの応答性

**パフォーマンス目標**:
- 画像読み込み: < 500ms
- 前処理: < 100ms
- 推論: < 200ms
- 描画: < 100ms
- **合計: < 1秒/画像**

**想定ファイル**:
- `main/main.cpp` - メインループ統合
- `main/inference_pipeline.cpp` - 推論パイプライン
- `main/inference_pipeline.h`

---

## Phase 7（将来拡張）: カメラ統合
**目的**: GC0308カメラからリアルタイムで画像を取得し、推論

**タスク**:
1. カメラ初期化の安定化
2. リアルタイム画像キャプチャ
3. フレームバッファ管理
4. 連続推論パイプライン

**備考**: 現在カメラ初期化に課題があるため、SD画像での動作確認後に実施

---

## 開発環境
- **Hardware**: M5Stack CoreS3 (ESP32-S3, 8MB PSRAM, 16MB Flash)
- **Framework**: ESP-IDF v5.5.1
- **Display**: ILI9341 (320x240, RGB565)
- **Libraries**: 
  - LVGL 9.4.0 (UI)
  - esp32-camera 2.1.4
  - ESP-DL 3.2.1 (推論)
  - esp_jpeg (画像デコード)

---

## 開発ガイドライン
1. **メモリ管理**: PSRAM優先使用、DRAMは最小限
2. **エラーハンドリング**: 全ファイル操作・推論でエラーチェック
3. **ログ**: 各フェーズで詳細なパフォーマンスログ
4. **テスト**: 各フェーズごとに単体テスト実施
5. **コード構造**: 機能ごとにモジュール分割

---

## 次のステップ
**Phase 2: microSDファイル読み込みテスト** に進む

---

*更新日: 2025/12/09*
*作成者: 開発チーム*
