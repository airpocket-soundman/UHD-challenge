# Phase 2A完了チェックリスト

## 📋 Phase 2A: カメラ統合（PSRAM不使用）

### 目標
DRAMのみでカメラから画像を取得し、前処理パイプラインが正常に動作することを確認する。

---

## ✅ 実装完了項目

### コード実装
- [x] カメラドライバ統合（GC0308）
- [x] DVPインターフェース設定（14本のGPIOピン）
- [x] QVGA (320×240) RGB565形式で取得
- [x] 画像処理パイプライン実装
  - [x] RGB565→RGB888変換
  - [x] 中央クロップ (240×240)
  - [x] Bilinearリサイズ (64×64)
  - [x] 正規化 (uint8→float32, [0,255]→[0.0,1.0])
- [x] FPS測定機能
- [x] メモリ使用量モニタリング

### 設定
- [x] PSRAMを無効化（CONFIG_SPIRAM=n）
- [x] CAMERA_FB_IN_DRAMに変更
- [x] ビルド成功

---

## 🧪 実機テスト（進行中）

### テスト1: ビルド・フラッシュ
- [x] クリーンビルド実行
- [ ] ビルド成功確認
- [ ] デバイスへのフラッシュ
- [ ] 起動成功

### テスト2: 基本動作確認
```
期待される出力:
I (xxx) MAIN: Phase 2A: Camera integration (DRAM only)
I (xxx) MAIN: [boot] Free heap: XXXXXX bytes
I (xxx) MAIN: Initializing camera (GC0308, QQVGA, RGB565)...
I (xxx) MAIN: Camera initialized
I (xxx) MAIN: Buffers allocated
I (xxx) MAIN: [after buffers] Free heap: XXXXXX bytes
```

確認項目:
- [ ] 起動メッセージが表示される
- [ ] PSRAMエラーが出ない
- [ ] カメラ初期化が成功する
- [ ] バッファ確保が成功する

### テスト3: カメラ動作確認
```
期待される出力:
I (xxx) MAIN: Captured first frame: 320x240 format=2 len=153600
I (xxx) MAIN: Captured XX frames in 1.00 s (XX.X FPS). Free heap: XXXXXX bytes
```

確認項目:
- [ ] カメラから画像取得できる
- [ ] フレームサイズが正しい（320×240）
- [ ] フォーマットが正しい（RGB565 = format 2）
- [ ] FPSが表示される

### テスト4: パフォーマンス測定
確認項目:
- [ ] FPS: **目標値10以上**（理想は30）
- [ ] メモリリークなし（Free heapが安定）
- [ ] 安定動作（クラッシュしない）
- [ ] 処理時間が許容範囲内

### テスト5: 長時間動作テスト（オプション）
- [ ] 1分間連続動作
- [ ] メモリ使用量が安定
- [ ] FPSが一定

---

## 📊 成功基準

### 必須項目（すべて満たす必要あり）
1. ✅ **ビルド成功**
2. ❓ **起動成功**（PSRAMエラーなし）
3. ❓ **カメラ初期化成功**
4. ❓ **画像取得成功**（最低1フレーム）
5. ❓ **前処理パイプライン動作**
6. ❓ **メモリリークなし**

### パフォーマンス目標
| 項目 | 目標値 | 最低限 | 理想 |
|------|--------|--------|------|
| FPS | - | 10以上 | 30 |
| Free Heap | - | 100KB以上 | 200KB以上 |
| 安定性 | - | 1分連続 | 10分連続 |

### 許容される問題
以下は許容範囲内：
- ✅ FPSが30未満（10以上なら可）
- ✅ フレームドロップが時々発生
- ✅ 起動時に若干のワーニング
- ✅ カメラセンサーの警告メッセージ

以下は許容できない：
- ❌ 起動しない
- ❌ カメラ初期化失敗
- ❌ クラッシュする
- ❌ メモリリークが発生
- ❌ 画像が取得できない

---

## 🔧 トラブルシューティング

### 問題1: PSRAMエラーが出る
```
E (173) octal_psram: PSRAM chip is not connected
```
**対処**: すでに修正済み（CONFIG_SPIRAM=n）

### 問題2: カメラ初期化失敗
```
E (xxx) MAIN: Camera init failed: ESP_ERR_XXX
```
**対処**:
1. ピン設定を確認
2. I2C通信を確認
3. カメラセンサーの種類を確認（GC0308 vs OV2640）
4. エラーメッセージを詳しく調査

### 問題3: メモリ不足
```
E (xxx) MAIN: Failed to allocate image buffers
```
**対処**:
1. バッファサイズを削減
2. fb_countを1に設定
3. 不要なコンポーネントを無効化

### 問題4: フレーム取得失敗
```
E (xxx) MAIN: Failed to acquire camera frame
```
**対処**:
1. カメラ設定を確認
2. クロック周波数を調整
3. フレームバッファの場所を確認（DRAM）

---

## 📝 実機テスト実行手順

### 1. 準備
```powershell
cd c:\Users\yamas\Documents\GitHub\UHD-challenge\ESP_IDF_Core3
. C:\Espressif\frameworks\esp-idf-v5.5.1\export.ps1
```

### 2. ビルド（実行中）
```powershell
idf.py fullclean
idf.py build
```

### 3. フラッシュ・モニター
```powershell
idf.py -p COM6 flash monitor
```

### 4. 観察ポイント
1. **起動時**: PSRAMエラーが出ないか
2. **初期化時**: カメラが認識されるか
3. **動作時**: FPSがどのくらいか
4. **メモリ**: Free heapが安定しているか

### 5. テスト終了
- Ctrl+] でモニターを終了
- ログを保存（必要に応じて）

---

## 🎯 Phase 2A完了の判定

### 完了条件
以下をすべて満たせば**Phase 2A完了**：

✅ **条件1**: ビルド成功  
✅ **条件2**: 起動成功（PSRAMエラーなし）  
❓ **条件3**: カメラ初期化成功  
❓ **条件4**: 画像取得成功（1秒間に最低10フレーム）  
❓ **条件5**: 前処理パイプライン動作  
❓ **条件6**: メモリリークなし（1分間安定動作）

### 完了後の次のステップ
Phase 2A完了後は**Phase 2B（LCD統合）**に進みます：
- M5Stack CoreS3 LCDドライバ統合
- カメラ画像をLCD画面に表示
- リアルタイム映像表示

---

## 📄 テスト結果記録

### 実行日時
2025年12月9日 午前9時

### ビルド結果
- [ ] ビルド成功
- [ ] バイナリサイズ: _____ KB
- [ ] ビルド時間: _____ 秒

### 実機テスト結果
記録予定:
```
起動ログ:
[ここに起動時のログを貼り付け]

動作ログ:
[ここに動作時のログを貼り付け]

FPS測定結果:
- 最小FPS: _____
- 最大FPS: _____
- 平均FPS: _____

メモリ使用量:
- 起動時Free heap: _____ bytes
- バッファ確保後Free heap: _____ bytes
- 動作中Free heap: _____ bytes
```

### 判定
- [ ] **成功**: すべての条件を満たした
- [ ] **部分成功**: 一部の条件のみ満たした
- [ ] **失敗**: 重大な問題が発生

### 備考
（問題点、気づいた点、次への改善点など）

---

**現在の状態**: ビルド進行中（875/1414、約62%完了）

**次のアクション**: ビルド完了を待ち、フラッシュ・テストを実行
